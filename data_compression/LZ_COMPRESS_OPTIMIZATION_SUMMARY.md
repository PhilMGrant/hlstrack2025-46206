# LZ压缩模块时序优化总结

## 优化目标
解决 lz_compress.hpp 文件中的时序违例问题，通过流水线化和关键路径优化来改善时序性能。

## 主要优化措施

### 1. 流水线化设计
- **第一个函数**: 将II从2增加到3，实现4阶段流水线
- **第二个函数**: 将II从2增加到4，实现4阶段流水线
- 添加中间寄存器来存储阶段间传递的数据

### 2. 哈希计算优化
- 使用移位和加法替代乘法运算
- 简化哈希函数，减少逻辑延迟
- 优化哈希掩码计算

### 3. 关键路径优化
- 预计算比较值和匹配长度
- 并行处理所有匹配级别
- 减少组合逻辑深度

### 4. dict_flush 优化
- **UNROLL FACTOR**: 从2增加到4，提高并行度
- **LOOP_TRIPCOUNT**: 添加循环计数提示，帮助HLS优化
- **内存访问优化**: 改善字典初始化时序
- **资源平衡**: 在时序和资源使用之间取得平衡

### 5. 资源优化
- 使用寄存器传递中间结果
- 完全展开关键循环
- 优化数组分区策略

## 具体优化细节

### 哈希函数优化
**原始实现:**
```cpp
hash = (present_window[0] * 17) ^ (present_window[1] * 13) ^ (present_window[2] * 7);
```

**优化后实现:**
```cpp
hash = (present_window[0] << 4) + present_window[0] + 
       (present_window[1] << 3) + present_window[1] + 
       (present_window[2] << 2) + present_window[2] + present_window[2];
```

### 流水线阶段划分
1. **阶段1**: 数据准备和哈希计算
2. **阶段2**: 字典查找和更新
3. **阶段3**: 匹配搜索和过滤
4. **阶段4**: 输出结果

### 寄存器传递优化
添加了以下中间寄存器：
- `hash_reg` - 哈希值寄存器
- `currIdx_reg` - 当前索引寄存器
- `dictReadValue_reg` - 字典读取值寄存器
- `present_window_reg` - 窗口数据寄存器

## 预期效果

### 时序改善
- 关键路径延迟显著减少
- 时钟频率提升潜力
- 时序违例问题得到缓解

### 资源影响
- 轻微增加寄存器使用
- 逻辑资源使用基本保持不变
- 性能与资源平衡优化

## 验证建议

1. **时序分析**: 使用Vivado HLS进行时序分析
2. **功能验证**: 确保压缩结果正确性
3. **性能测试**: 比较优化前后的吞吐量

## 注意事项

- 流水线II的增加会轻微影响吞吐量
- 需要平衡时序和性能需求
- 建议在实际硬件上进行最终验证

## 后续优化方向

1. 进一步优化匹配搜索算法
2. 考虑使用更高效的哈希函数
3. 探索更细粒度的流水线划分
4. 优化内存访问模式
